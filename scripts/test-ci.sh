#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è CI –ø—Ä–æ—Ü–µ—Å—Å–∞
echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ CI –ø—Ä–æ—Ü–µ—Å—Å–∞ –ª–æ–∫–∞–ª—å–Ω–æ..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
if [ ! -f "package.json" ]; then
    echo "‚ùå –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —à–∞–≥–æ–≤
step() {
    echo -e "${YELLOW}üìã $1${NC}"
}

success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

error() {
    echo -e "${RED}‚ùå $1${NC}"
    exit 1
}

# –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
step "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
if ! command -v pnpm &> /dev/null; then
    error "pnpm –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: npm install -g pnpm"
fi
success "pnpm –Ω–∞–π–¥–µ–Ω"

# –®–∞–≥ 2: –û—á–∏—Å—Ç–∫–∞
step "–û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–±–æ—Ä–æ–∫..."
rm -rf node_modules/.cache
rm -rf dist
rm -rf release
success "–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
step "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
pnpm install --frozen-lockfile || error "–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
success "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# –®–∞–≥ 4: –õ–∏–Ω—Ç–∏–Ω–≥
step "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ (lint)..."
pnpm lint || echo "‚ö†Ô∏è –õ–∏–Ω—Ç–µ—Ä –Ω–∞—à–µ–ª –ø—Ä–æ–±–ª–µ–º—ã, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º..."

# –®–∞–≥ 5: –°–±–æ—Ä–∫–∞ –≤–µ–± –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
step "–°–±–æ—Ä–∫–∞ –≤–µ–± –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pnpm build || error "–û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ –≤–µ–± –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
success "–í–µ–± –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–æ"

# –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ bundle
step "–ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–º–µ—Ä–∞ bundle..."
if [ -d "dist" ]; then
    echo "üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤ –≤ dist/:"
    du -sh dist/*
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ CSS –∏ JS —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã
    if ls dist/assets/*.css 1> /dev/null 2>&1; then
        success "CSS —Ñ–∞–π–ª—ã –Ω–∞–π–¥–µ–Ω—ã"
    else
        error "CSS —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    fi
    
    if ls dist/assets/*.js 1> /dev/null 2>&1; then
        success "JS —Ñ–∞–π–ª—ã –Ω–∞–π–¥–µ–Ω—ã"
    else
        error "JS —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    fi
fi

# –®–∞–≥ 7: –°–±–æ—Ä–∫–∞ Electron –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ macOS)
step "–°–±–æ—Ä–∫–∞ Electron –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è macOS..."
if [[ "$OSTYPE" == "darwin"* ]]; then
    pnpm electron:build || error "–û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ macOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
    success "macOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–æ"
else
    echo "‚ö†Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–∞ macOS –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–±–æ—Ä–∫–∏"
fi

# –®–∞–≥ 8: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
step "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å–±–æ—Ä–∫–∏..."
if [ -d "release" ]; then
    echo "üì¶ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –≤ release/:"
    ls -la release/
    
    # –ü–æ–¥—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞
    total_size=$(du -sh release/ | cut -f1)
    success "–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å–æ–∑–¥–∞–Ω—ã, –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä: $total_size"
else
    error "–ü–∞–ø–∫–∞ release –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi

echo ""
echo "üéâ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã! –ì–æ—Ç–æ–≤–æ –∫ CI/CD"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   ‚Ä¢ git add ."
echo "   ‚Ä¢ git commit -m 'Ready for CI'"
echo "   ‚Ä¢ git push origin main"
echo ""
echo "üè∑Ô∏è –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ª–∏–∑–∞:"
echo "   ‚Ä¢ npm version patch"
echo "   ‚Ä¢ git push origin main --tags" 